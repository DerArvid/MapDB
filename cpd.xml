<?xml version="1.0" encoding="UTF-8"?>
<pmd-cpd>
<duplication lines="24" tokens="194">
<file line="123" path="/home/jan/MapDB/MapDB/src/main/java/org/mapdb/Fun.java"/>
<file line="193" path="/home/jan/MapDB/MapDB/src/main/java/org/mapdb/Fun.java"/>
<codefragment>
<![CDATA[
            final Tuple3 oo = (Tuple3) o;
            if(a!=oo.a){
                if(a==null || oo.a==HI) return -1;
                if(a==HI ||  oo.a==null) return 1;

                final int c = ((Comparable)a).compareTo(oo.a);
                if(c!=0) return c;
            }

            if(b!=oo.b){
                if(b==null || oo.b==HI) return -1;
                if(b==HI || oo.b==null) return 1;

                final int i = ((Comparable)b).compareTo(oo.b);
                if(i!=0) return i;
            }

            if(c!=oo.c){
                if(c==null || oo.c==HI) return -1;
                if(c==HI || oo.c==null) return 1;

                final int i = ((Comparable)c).compareTo(oo.c);
                if(i!=0) return i;
            }
]]>
</codefragment>
</duplication>
<duplication lines="22" tokens="144">
<file line="841" path="/home/jan/MapDB/MapDB/src/main/java/org/mapdb/BTreeMap.java"/>
<file line="889" path="/home/jan/MapDB/MapDB/src/main/java/org/mapdb/BTreeMap.java"/>
<codefragment>
<![CDATA[
        if(key == null || oldValue == null || newValue == null ) throw new NullPointerException();

        long current = rootRecid;
        BNode node = engine.recordGet(current, nodeSerializer);
        //dive until leaf is found
        while(!node.isLeaf()){
            current = nextDir((DirNode) node, key);
            node = engine.recordGet(current, nodeSerializer);
        }

        nodeLocks.lock(current);
        LeafNode leaf = (LeafNode) engine.recordGet(current, nodeSerializer);

        int pos = findChildren(key, node.keys());
        while(pos==leaf.keys.length){
            //follow leaf link until necessary
            nodeLocks.lock(leaf.next);
            nodeLocks.unlock(current);
            current = leaf.next;
            leaf = (LeafNode) engine.recordGet(current, nodeSerializer);
            pos = findChildren(key, node.keys());
        }
]]>
</codefragment>
</duplication>
<duplication lines="16" tokens="130">
<file line="69" path="/home/jan/MapDB/MapDB/src/main/java/org/mapdb/Fun.java"/>
<file line="123" path="/home/jan/MapDB/MapDB/src/main/java/org/mapdb/Fun.java"/>
<file line="193" path="/home/jan/MapDB/MapDB/src/main/java/org/mapdb/Fun.java"/>
<codefragment>
<![CDATA[
            final Tuple2 oo = (Tuple2) o;
            if(a!=oo.a){
                if(a==null || oo.a==HI) return -1;
                if(a==HI || oo.a==null) return 1;

                final int c = ((Comparable)a).compareTo(oo.a);
                if(c!=0) return c;
            }

            if(b!=oo.b){
                if(b==null || oo.b==HI) return -1;
                if(b==HI || oo.b==null) return 1;

                final int i = ((Comparable)b).compareTo(oo.b);
                if(i!=0) return i;
            }
]]>
</codefragment>
</duplication>
<duplication lines="21" tokens="127">
<file line="1289" path="/home/jan/MapDB/MapDB/src/main/java/org/mapdb/BTreeMap.java"/>
<file line="1430" path="/home/jan/MapDB/MapDB/src/main/java/org/mapdb/BTreeMap.java"/>
<codefragment>
<![CDATA[
                return ((BTreeMap.SubMap<E,Object>)m).keyIterator();
        }
        @Override
		public boolean equals(Object o) {
            if (o == this)
                return true;
            if (!(o instanceof Set))
                return false;
            Collection<?> c = (Collection<?>) o;
            try {
                return containsAll(c) && c.containsAll(this);
            } catch (ClassCastException unused)   {
                return false;
            } catch (NullPointerException unused) {
                return false;
            }
        }
        @Override
		public Object[] toArray()     { return toList(this).toArray();  }
        @Override
		public <T> T[] toArray(T[] a) { return toList(this).toArray(a); }
]]>
</codefragment>
</duplication>
<duplication lines="17" tokens="126">
<file line="52" path="/home/jan/MapDB/MapDB/src/main/java/org/mapdb/CacheHashTable.java"/>
<file line="59" path="/home/jan/MapDB/MapDB/src/main/java/org/mapdb/CacheHashTableSynchronized.java"/>
<codefragment>
<![CDATA[
    }

    @Override
    public <A> long recordPut(A value, Serializer<A> serializer) {
        //no need for locking, as recid is not propagated outside of method yet
        final long recid = engine.recordPut(value, serializer);
        items[Math.abs(Utils.longHash(recid))%cacheMaxSize] = new HashItem(recid, value);
        return recid;
    }

    @Override
    @SuppressWarnings("unchecked")
    public <A> A recordGet(long recid, Serializer<A> serializer) {
        final int pos = Math.abs(Utils.longHash(recid))%cacheMaxSize;
        HashItem item = items[pos];
        if(item!=null && recid == item.key)
            return (A) item.val;
]]>
</codefragment>
</duplication>
<duplication lines="14" tokens="122">
<file line="660" path="/home/jan/MapDB/MapDB/src/main/java/org/mapdb/LongConcurrentLRUMap.java"/>
<file line="688" path="/home/jan/MapDB/MapDB/src/main/java/org/mapdb/LongConcurrentLRUMap.java"/>
<codefragment>
<![CDATA[
  public Map<Long,V> getOldestAccessedItems(int n) {
    Map<Long,V> result = new LinkedHashMap<Long,V>();
    if (n <= 0)
      return result;
    TreeSet<CacheEntry<V>> tree = new TreeSet<CacheEntry<V>>();
    markAndSweepLock.lock();
    try {
        for( Iterator<CacheEntry<V>> iter = map.valuesIterator(); iter.hasNext();){
        CacheEntry<V> ce = iter.next();
        ce.lastAccessedCopy = ce.lastAccessed;
        if (tree.size() < n) {
          tree.add(ce);
        } else {
          if (ce.lastAccessedCopy < tree.first().lastAccessedCopy) {
]]>
</codefragment>
</duplication>
<duplication lines="3" tokens="121">
<file line="72" path="/home/jan/MapDB/MapDB/src/main/java/org/mapdb/EncryptionXTEA.java"/>
<file line="95" path="/home/jan/MapDB/MapDB/src/main/java/org/mapdb/EncryptionXTEA.java"/>
<codefragment>
<![CDATA[
    private void encryptBlock(byte[] in, byte[] out, int off) {
        int y = (in[off] << 24) | ((in[off+1] & 255) << 16) | ((in[off+2] & 255) << 8) | (in[off+3] & 255);
        int z = (in[off+4] << 24) | ((in[off+5] & 255) << 16) | ((in[off+6] & 255) << 8) | (in[off+7] & 255);
]]>
</codefragment>
</duplication>
<duplication lines="5" tokens="118">
<file line="91" path="/home/jan/MapDB/MapDB/src/main/java/org/mapdb/EncryptionXTEA.java"/>
<file line="114" path="/home/jan/MapDB/MapDB/src/main/java/org/mapdb/EncryptionXTEA.java"/>
<codefragment>
<![CDATA[
        out[off] = (byte) (y >> 24); out[off+1] = (byte) (y >> 16); out[off+2] = (byte) (y >> 8); out[off+3] = (byte) y;
        out[off+4] = (byte) (z >> 24); out[off+5] = (byte) (z >> 16); out[off+6] = (byte) (z >> 8); out[off+7] = (byte) z;
    }

    private void decryptBlock(byte[] in, byte[] out, int off) {
]]>
</codefragment>
</duplication>
<duplication lines="22" tokens="113">
<file line="951" path="/home/jan/MapDB/MapDB/src/main/java/org/mapdb/BTreeMap.java"/>
<file line="1657" path="/home/jan/MapDB/MapDB/src/main/java/org/mapdb/BTreeMap.java"/>
<codefragment>
<![CDATA[
    }


    @Override
    public Entry<K, V> pollFirstEntry() {
        while(true){
            Entry<K, V> e = firstEntry();
            if(e==null || remove(e.getKey(),e.getValue())){
                return e;
            }
        }
    }

    @Override
    public Entry<K, V> pollLastEntry() {
        while(true){
            Entry<K, V> e = lastEntry();
            if(e==null || remove(e.getKey(),e.getValue())){
                return e;
            }
        }
    }
]]>
</codefragment>
</duplication>
<duplication lines="18" tokens="113">
<file line="376" path="/home/jan/MapDB/MapDB/src/main/java/org/mapdb/HTreeMap.java"/>
<file line="479" path="/home/jan/MapDB/MapDB/src/main/java/org/mapdb/HTreeMap.java"/>
<codefragment>
<![CDATA[
                long[][] dir = engine.recordGet(dirRecid, DIR_SERIALIZER);
                final int slot =  (h>>>(7*level )) & 0x7F;
                if(CC.ASSERT && slot>127) throw new InternalError();

                if(dir == null ){
                    //create new dir
                    dir = new long[16][];
                }

                if(dir[slot/8] == null){
                    dir[slot/8] = new long[8];
                }

                int counter = 0;
                long recid = dir[slot/8][slot%8];

                if(recid!=0){
                    if((recid&1) == 0){
]]>
</codefragment>
</duplication>
</pmd-cpd>